From ebb48bc7be16849c1c44f6915a603d215e7e0f9b Mon Sep 17 00:00:00 2001
From: Wim Taymans <wtaymans@redhat.com>
Date: Wed, 26 Feb 2020 12:35:34 +0100
Subject: [PATCH] Add profile-set for Carbon X1

---
 src/Makefile.am                               |  2 +
 src/modules/alsa/90-pulseaudio.rules          |  4 ++
 .../mixer/paths/digital-input-front-mic.conf  | 12 ++++++
 .../mixer/profile-sets/sof-hda-dsp-dmic4.conf | 41 +++++++++++++++++++
 4 files changed, 59 insertions(+)
 create mode 100644 src/modules/alsa/mixer/paths/digital-input-front-mic.conf
 create mode 100644 src/modules/alsa/mixer/profile-sets/sof-hda-dsp-dmic4.conf

diff --git a/src/Makefile.am b/src/Makefile.am
index 437311de6..262156a7a 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1345,6 +1345,7 @@ dist_alsaprofilesets_DATA = \
 		modules/alsa/mixer/profile-sets/native-instruments-korecontroller.conf \
 		modules/alsa/mixer/profile-sets/kinect-audio.conf \
 		modules/alsa/mixer/profile-sets/sb-omni-surround-5.1.conf \
+		modules/alsa/mixer/profile-sets/sof-hda-dsp-dmic4.conf \
 		modules/alsa/mixer/profile-sets/steelseries-arctis-5-usb-audio.conf \
 		modules/alsa/mixer/profile-sets/steelseries-arctis-7-usb-audio.conf \
 		modules/alsa/mixer/profile-sets/dell-dock-tb16-usb-audio.conf \
@@ -1381,6 +1382,7 @@ dist_alsapaths_DATA = \
 		modules/alsa/mixer/paths/analog-output-headphones-2.conf \
 		modules/alsa/mixer/paths/analog-output-lineout.conf \
 		modules/alsa/mixer/paths/analog-output-mono.conf \
+		modules/alsa/mixer/paths/digital-input-front-mic.conf \
 		modules/alsa/mixer/paths/iec958-stereo-input.conf \
 		modules/alsa/mixer/paths/iec958-stereo-output.conf \
 		modules/alsa/mixer/paths/hdmi-output-0.conf \
diff --git a/src/modules/alsa/90-pulseaudio.rules b/src/modules/alsa/90-pulseaudio.rules
index d85763917..a33faf282 100644
--- a/src/modules/alsa/90-pulseaudio.rules
+++ b/src/modules/alsa/90-pulseaudio.rules
@@ -18,6 +18,10 @@
 SUBSYSTEM!="sound", GOTO="pulseaudio_end"
 ACTION!="change", GOTO="pulseaudio_end"
 KERNEL!="card*", GOTO="pulseaudio_end"
+
+# Carbon X1
+SUBSYSTEMS=="pci", ATTRS{vendor}=="0x8086", ATTRS{device}=="0x9dc8", ENV{PULSE_PROFILE_SET}="sof-hda-dsp-dmic4.conf"
+
 SUBSYSTEMS=="usb", GOTO="pulseaudio_check_usb"
 SUBSYSTEMS=="firewire", GOTO="pulseaudio_firewire_quirk"
 
diff --git a/src/modules/alsa/mixer/paths/digital-input-front-mic.conf b/src/modules/alsa/mixer/paths/digital-input-front-mic.conf
new file mode 100644
index 000000000..89397287b
--- /dev/null
+++ b/src/modules/alsa/mixer/paths/digital-input-front-mic.conf
@@ -0,0 +1,12 @@
+[General]
+priority = 91
+description-key = input-microphone-internal
+
+[Properties]
+device.icon_name = audio-input-microphone
+
+[Element Dmic0]
+switch = mute
+volume = merge
+override-map.1 = all
+override-map.2 = all-left,all-right
diff --git a/src/modules/alsa/mixer/profile-sets/sof-hda-dsp-dmic4.conf b/src/modules/alsa/mixer/profile-sets/sof-hda-dsp-dmic4.conf
new file mode 100644
index 000000000..51f57d67e
--- /dev/null
+++ b/src/modules/alsa/mixer/profile-sets/sof-hda-dsp-dmic4.conf
@@ -0,0 +1,41 @@
+[General]
+auto-profiles = yes
+
+[Mapping digital-front-mic-input]
+description = Digital Microphone
+device-strings = hw:%f,6
+paths-input = digital-input-front-mic
+channel-map = left,right,left,right
+priority = 20
+direction = input
+
+[Mapping analog-stereo]
+device-strings = hw:%f
+channel-map = left,right
+paths-output = analog-output analog-output-lineout analog-output-speaker analog-output-headphones analog-output-headphones-2
+paths-input = analog-input-front-mic analog-input-rear-mic analog-input-dock-mic analog-input analog-input-mic analog-input-linein analog-input-aux analog-input-video analog-input-tvtuner analog-input-fm analog-input-mic-line analog-input-headphone-mic analog-input-headset-mic
+priority = 15
+
+[Mapping hdmi-stereo]
+description = Digital Stereo (HDMI 1)
+device-strings = hw:%f,3
+paths-output = hdmi-output-0
+channel-map = left,right
+priority = 7
+direction = output
+
+[Mapping hdmi-stereo-extra1]
+description = Digital Stereo (HDMI 2)
+device-strings = hw:%f,4
+paths-output = hdmi-output-1
+channel-map = left,right
+priority = 6
+direction = output
+
+[Mapping hdmi-stereo-extra2]
+description = Digital Stereo (HDMI 3)
+device-strings = hw:%f,5
+paths-output = hdmi-output-2
+channel-map = left,right
+priority = 5
+direction = output
-- 
2.24.1

